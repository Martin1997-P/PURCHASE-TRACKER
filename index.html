== 'EUR') {
            rate = 156.75;
          }
          
          $('#exchangeRate').val(rate);
          $('#rateLoader').addClass('hidden');
          calculateTotal();
        }, 1000);
      });

      // Display selected files
      $('#documents').on('change', function(e) {
        const fileList = $('#fileList');
        fileList.empty();
        
        const files = e.target.files;
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const fileSize = (file.size / 1024 / 1024).toFixed(2); // in MB
          
          const fileItem = $('<div class="text-sm text-gray-500 flex items-center"></div>');
          fileItem.append(`<i class="fas fa-file-alt text-indigo-500 mr-2"></i>`);
          fileItem.append(`<span>${file.name} (${fileSize} MB)</span>`);
          
          fileList.append(fileItem);
        }
      });

      // Load data from localStorage on page load
      function loadPurchases() {
        let purchases = JSON.parse(localStorage.getItem('purchases')) || [];
        
        // Clear table
        table.clear();
        
        // Add each purchase to table
        purchases.forEach(purchase => {
          addPurchaseToTable(purchase);
        });
        
        // Redraw table
        table.draw();
        
        // Update totals
        updateTotals();
        
        // Update filter options
        updateFilterOptions(purchases);
      }

      // Add purchase to DataTable
      function addPurchaseToTable(purchase) {
        const statusClass = `status-${purchase.status.toLowerCase().replace(/\s+/g, '-')}`;
        
        const documentsList = purchase.documents && purchase.documents.length 
          ? purchase.documents.map(doc => `<span class="text-xs block"><i class="fas fa-file-alt mr-1"></i>${doc}</span>`).join('') 
          : '<span class="text-xs text-gray-400">No documents</span>';
          
        table.row.add([
          purchase.poNumber,
          purchase.supplierName,
          purchase.itemDescription,
          purchase.quantity,
          `${purchase.currency} ${parseFloat(purchase.unitPrice).toFixed(2)}`,
          `${purchase.currency} ${parseFloat(purchase.quantity * purchase.unitPrice).toFixed(2)}`,
          purchase.currency,
          `KES ${parseFloat(purchase.totalValueKES).toFixed(2)}`,
          purchase.incoterm,
          purchase.countryOfOrigin,
          purchase.modeOfShipment,
          purchase.eta || '-',
          purchase.etd || '-',
          `KES ${parseFloat(purchase.freightCost || 0).toFixed(2)}`,
          `<span class="px-2 py-1 text-xs rounded-full ${statusClass}">${purchase.status}</span>`,
          documentsList,
          purchase.remarks || '-',
          `<button class="text-blue-500 hover:text-blue-700 mr-2" data-id="${purchase.id}" data-action="edit"><i class="fas fa-edit"></i></button>
           <button class="text-red-500 hover:text-red-700" data-id="${purchase.id}" data-action="delete"><i class="fas fa-trash-alt"></i></button>`
        ]).draw(false);
      }

      // Update totals
      function updateTotals() {
        const purchases = JSON.parse(localStorage.getItem('purchases')) || [];
        
        let totalQuantity = 0;
        let totalKES = 0;
        let totalUSD = 0;
        let totalEUR = 0;
        
        purchases.forEach(purchase => {
          totalQuantity += parseFloat(purchase.quantity);
          totalKES += parseFloat(purchase.totalValueKES);
          
          const itemTotal = parseFloat(purchase.quantity) * parseFloat(purchase.unitPrice);
          if (purchase.currency === 'USD') {
            totalUSD += itemTotal;
          } else if (purchase.currency === 'EUR') {
            totalEUR += itemTotal;
          }
        });
        
        $('#total-quantity').text(totalQuantity);
        $('#total-kes').text(`KES ${totalKES.toFixed(2)}`);
        
        let totalValueText = '';
        if (totalKES > 0) totalValueText += `KES ${totalKES.toFixed(2)} `;
        if (totalUSD > 0) totalValueText += `USD ${totalUSD.toFixed(2)} `;
        if (totalEUR > 0) totalValueText += `EUR ${totalEUR.toFixed(2)}`;
        
        $('#total-value').text(totalValueText || '-');
      }

      // Update filter options
      function updateFilterOptions(purchases) {
        const suppliers = [...new Set(purchases.map(p => p.supplierName))];
        
        // Clear and repopulate supplier filter
        const supplierFilter = $('#filter-supplier');
        const currentSupplier = supplierFilter.val();
        supplierFilter.empty().append('<option value="">All Suppliers</option>');
        
        suppliers.forEach(supplier => {
          supplierFilter.append(`<option value="${supplier}">${supplier}</option>`);
        });
        
        if (currentSupplier && suppliers.includes(currentSupplier)) {
          supplierFilter.val(currentSupplier);
        }
        
        // Refresh select2
        $('.filter-select').trigger('change');
      }

      // Apply filters to DataTable
      $('.filter-select').on('change', function() {
        const supplierFilter = $('#filter-supplier').val();
        const currencyFilter = $('#filter-currency').val();
        const shipmentFilter = $('#filter-shipment').val();
        const statusFilter = $('#filter-status').val();
        
        // Custom filtering function
        $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
          const supplier = data[1]; // Supplier Name column
          const currency = data[6]; // Currency column
          const shipment = data[10]; // Mode of Shipment column
          const status = data[14].replace(/<[^>]*>/g, ''); // Status column (removing HTML)
          
          // Check each filter
          if (supplierFilter && supplier !== supplierFilter) return false;
          if (currencyFilter && currency !== currencyFilter) return false;
          if (shipmentFilter && shipment !== shipmentFilter) return false;
          if (statusFilter && !status.includes(statusFilter)) return false;
          
          return true;
        });
        
        // Redraw table with filters applied
        table.draw();
        
        // Remove the custom filtering function
        $.fn.dataTable.ext.search.pop();
      });

      // Handle form submission
      $('#purchaseForm').on('submit', function(e) {
        e.preventDefault();
        
        // Get form data
        const formData = {
          id: new Date().getTime(), // Unique ID
          poNumber: $('#poNumber').val(),
          supplierName: $('#supplierName').val(),
          itemDescription: $('#itemDescription').val(),
          quantity: parseFloat($('#quantity').val()),
          unitPrice: parseFloat($('#unitPrice').val()),
          currency: $('#currency').val(),
          exchangeRate: parseFloat($('#exchangeRate').val()),
          totalValueKES: parseFloat($('#quantity').val()) * parseFloat($('#unitPrice').val()) * parseFloat($('#exchangeRate').val()),
          incoterm: $('#incoterm').val(),
          countryOfOrigin: $('#countryOfOrigin').val(),
          modeOfShipment: $('#modeOfShipment').val(),
          etd: $('#etd').val(),
          eta: $('#eta').val(),
          freightCost: parseFloat($('#freightCost').val() || 0),
          status: $('#status').val(),
          remarks: $('#remarks').val(),
          documents: Array.from($('#documents')[0].files || []).map(file => file.name)
        };
        
        // Save to localStorage
        const purchases = JSON.parse(localStorage.getItem('purchases')) || [];
        purchases.push(formData);
        localStorage.setItem('purchases', JSON.stringify(purchases));
        
        // Add to table
        addPurchaseToTable(formData);
        
        // Update totals
        updateTotals();
        
        // Update filter options
        updateFilterOptions(purchases);
        
        // Show success message
        Toastify({
          text: "Purchase added successfully!",
          duration: 3000,
          gravity: "bottom",
          position: "right",
          backgroundColor: "#10B981",
          stopOnFocus: true
        }).showToast();
        
        // Close modal and reset form
        closeModal();
      });

      // Handle edit and delete actions
      $('#purchases-tbody').on('click', 'button', function() {
        const action = $(this).data('action');
        const id = $(this).data('id');
        const purchases = JSON.parse(localStorage.getItem('purchases')) || [];
        const purchaseIndex = purchases.findIndex(p => p.id === id);
        
        if (purchaseIndex === -1) return;
        
        if (action === 'delete') {
          if (confirm('Are you sure you want to delete this purchase?')) {
            purchases.splice(purchaseIndex, 1);
            localStorage.setItem('purchases', JSON.stringify(purchases));
            
            table.row($(this).parents('tr')).remove().draw();
            updateTotals();
            updateFilterOptions(purchases);
            
            Toastify({
              text: "Purchase deleted successfully!",
              duration: 3000,
              gravity: "bottom",
              position: "right",
              backgroundColor: "#EF4444",
              stopOnFocus: true
            }).showToast();
          }
        } else if (action === 'edit') {
          // For now, just show a message that editing will be implemented later
          Toastify({
            text: "Editing functionality will be added in a future update",
            duration: 3000,
            gravity: "bottom",
            position: "right",
            backgroundColor: "#3B82F6",
            stopOnFocus: true
          }).showToast();
        }
      });
      
      // Load purchases on page load
      loadPurchases();
      
      // Set default exchange rates
      $('#currency').val('KES').trigger('change');
      $('#exchangeRate').val(1);
    });
  </script>
</body>
          </html>