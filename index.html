<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Burhani Engineers Ltd - Purchase Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <style id="app-style">
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: #f9fafb;
    }
    
    .modal {
      transition: opacity 0.25s ease;
    }
    
    .modal-active {
      overflow-y: visible !important;
      padding-right: 0 !important;
    }
    
    .select2-container {
      width: 100% !important;
    }
    
    .select2-selection {
      height: 42px !important;
      border-color: #d1d5db !important;
      border-radius: 0.375rem !important;
      padding: 0.375rem 0.75rem !important;
    }
    
    .select2-selection__arrow {
      height: 42px !important;
    }
    
    .loader {
      border-top-color: #3498db;
      -webkit-animation: spinner 1.5s linear infinite;
      animation: spinner 1.5s linear infinite;
    }
    
    @-webkit-keyframes spinner {
      0% { -webkit-transform: rotate(0deg); }
      100% { -webkit-transform: rotate(360deg); }
    }
    
    @keyframes spinner {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .dataTables_wrapper .dataTables_filter input {
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      padding: 0.375rem 0.75rem;
      margin-left: 0.5rem;
    }
    
    .dataTables_wrapper .dataTables_length select {
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      padding: 0.375rem 0.5rem;
      margin: 0 0.5rem;
    }
    
    table.dataTable thead th {
      position: relative;
      background-image: none !important;
    }
    
    table.dataTable thead th.sorting:after,
    table.dataTable thead th.sorting_asc:after,
    table.dataTable thead th.sorting_desc:after {
      position: absolute;
      right: 8px;
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      opacity: 0.5;
    }
    
    table.dataTable thead th.sorting:after {
      content: "\f0dc";
      opacity: 0.2;
    }
    
    table.dataTable thead th.sorting_asc:after {
      content: "\f0de";
    }
    
    table.dataTable thead th.sorting_desc:after {
      content: "\f0dd";
    }
    
    .status-ordered { background-color: #FEF3C7; color: #92400E; }
    .status-in-production { background-color: #DBEAFE; color: #1E40AF; }
    .status-ready { background-color: #D1FAE5; color: #065F46; }
    .status-shipped { background-color: #E0E7FF; color: #3730A3; }
    .status-cleared { background-color: #FEE2E2; color: #991B1B; }
    .status-delivered { background-color: #ECFDF5; color: #064E3B; }
  </style>
</head>
<body class="antialiased">
  <div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex justify-between items-center">
        <div class="flex items-center">
          <img src="https://cdn.pixabay.com/photo/2018/05/08/21/28/engineering-3384589_960_720.png" alt="Burhani Engineers Logo" class="h-10 w-auto mr-4">
          <h1 class="text-2xl font-bold text-gray-900">Burhani Engineers Ltd â€“ Purchase Tracker</h1>
        </div>
        <button id="addPurchaseBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
          <i class="fas fa-plus mr-2"></i> Add New Purchase
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Filters -->
      <div class="bg-white shadow rounded-lg mb-8 p-6">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Filters</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div>
            <label for="filter-supplier" class="block text-sm font-medium text-gray-700 mb-1">Supplier</label>
            <select id="filter-supplier" class="filter-select w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
              <option value="">All Suppliers</option>
            </select>
          </div>
          <div>
            <label for="filter-currency" class="block text-sm font-medium text-gray-700 mb-1">Currency</label>
            <select id="filter-currency" class="filter-select w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
              <option value="">All Currencies</option>
              <option value="KES">KES</option>
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
            </select>
          </div>
          <div>
            <label for="filter-shipment" class="block text-sm font-medium text-gray-700 mb-1">Mode of Shipment</label>
            <select id="filter-shipment" class="filter-select w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
              <option value="">All Modes</option>
              <option value="Air">Air</option>
              <option value="Sea">Sea</option>
              <option value="Courier">Courier</option>
            </select>
          </div>
          <div>
            <label for="filter-status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
            <select id="filter-status" class="filter-select w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
              <option value="">All Statuses</option>
              <option value="Ordered">Ordered</option>
              <option value="In Production">In Production</option>
              <option value="Ready">Ready</option>
              <option value="Shipped">Shipped</option>
              <option value="Cleared">Cleared</option>
              <option value="Delivered">Delivered</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Purchases Table -->
      <div class="bg-white shadow rounded-lg overflow-hidden">
        <div class="p-6">
          <h2 class="text-lg font-medium text-gray-900 mb-4">Purchase Orders</h2>
          <div class="overflow-x-auto">
            <table id="purchases-table" class="min-w-full divide-y divide-gray-200 stripe hover">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PO Number</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supplier</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qty</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit Price</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Value</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Currency</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total (KES)</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Incoterm</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Origin</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Shipping</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ETA</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ETD</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Freight (KES)</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Documents</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Remarks</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200" id="purchases-tbody">
                <!-- Data will be inserted here -->
              </tbody>
              <tfoot>
                <tr class="bg-gray-100">
                  <th colspan="3" class="px-6 py-3 text-left text-sm font-medium text-gray-900">Totals:</th>
                  <th id="total-quantity" class="px-6 py-3 text-left text-sm font-medium text-gray-900">0</th>
                  <th class="px-6 py-3 text-left text-sm font-medium text-gray-900">-</th>
                  <th id="total-value" class="px-6 py-3 text-left text-sm font-medium text-gray-900">-</th>
                  <th class="px-6 py-3 text-left text-sm font-medium text-gray-900">-</th>
                  <th id="total-kes" class="px-6 py-3 text-left text-sm font-medium text-gray-900">KES 0.00</th>
                  <th colspan="10" class="px-6 py-3 text-left text-sm font-medium text-gray-900"></th>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </main>

    <!-- Add Purchase Modal -->
    <div id="addPurchaseModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
      <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
      
      <div class="modal-container bg-white w-11/12 md:max-w-4xl mx-auto rounded shadow-lg z-50 overflow-y-auto max-h-[90vh]">
        <div class="modal-content py-4 text-left px-6">
          <!-- Modal Header -->
          <div class="flex justify-between items-center pb-3 border-b">
            <p class="text-xl font-bold">Add New Purchase</p>
            <button id="closeModal" class="modal-close cursor-pointer z-50">
              <i class="fas fa-times text-gray-500 hover:text-gray-800"></i>
            </button>
          </div>

          <!-- Modal Body -->
          <form id="purchaseForm" class="mt-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="col-span-1">
                <label for="poNumber" class="block text-sm font-medium text-gray-700 mb-1">PO Number</label>
                <input type="text" id="poNumber" name="poNumber" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
              </div>
              
              <div class="col-span-1">
                <label for="supplierName" class="block text-sm font-medium text-gray-700 mb-1">Supplier Name</label>
                <input type="text" id="supplierName" name="supplierName" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
              </div>
              
              <div class="col-span-2">
                <label for="itemDescription" class="block text-sm font-medium text-gray-700 mb-1">Item Description</label>
                <textarea id="itemDescription" name="itemDescription" rows="2" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></textarea>
              </div>
              
              <div class="col-span-1">
                <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                <input type="number" id="quantity" name="quantity" min="1" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
              </div>
              
              <div class="col-span-1">
                <label for="unitPrice" class="block text-sm font-medium text-gray-700 mb-1">Unit Price</label>
                <div class="flex">
                  <input type="number" id="unitPrice" name="unitPrice" min="0" step="0.01" required class="w-2/3 rounded-l-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                  <select id="currency" name="currency" class="w-1/3 rounded-r-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    <option value="KES">KES</option>
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                  </select>
                </div>
              </div>
              
              <div class="col-span-1">
                <label for="exchangeRate" class="block text-sm font-medium text-gray-700 mb-1">Exchange Rate to KES</label>
                <div class="relative">
                  <input type="number" id="exchangeRate" name="exchangeRate" min="0" step="0.01" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 pl-10">
                  <div id="rateLoader" class="hidden absolute inset-y-0 left-0 flex items-center pl-3">
                    <svg class="animate-spin h-4 w-4 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                  </div>
                </div>
              </div>
              
              <div class="col-span-1">
                <label for="totalValue" class="block text-sm font-medium text-gray-700 mb-1">Total Value</label>
                <input type="text" id="totalValue" name="totalValue" readonly class="w-full rounded-md border-gray-300 bg-gray-100 shadow-sm">
              </div>
              
              <div class="col-span-1">
                <label for="totalValueKES" class="block text-sm font-medium text-gray-700 mb-1">Total Value in KES</label>
                <input type="text" id="totalValueKES" name="totalValueKES" readonly class="w-full rounded-md border-gray-300 bg-gray-100 shadow-sm">
              </div>
              
              <div class="col-span-1">
                <label for="incoterm" class="block text-sm font-medium text-gray-700 mb-1">Incoterm</label>
                <select id="incoterm" name="incoterm" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                  <option value="FOB">FOB</option>
                  <option value="CIF">CIF</option>
                  <option value="EXW">EXW</option>
                  <option value="DDP">DDP</option>
                  <option value="CFR">CFR</option>
                  <option value="CIP">CIP</option>
                </select>
              </div>
              
              <div class="col-span-1">
                <label for="countryOfOrigin" class="block text-sm font-medium text-gray-700 mb-1">Country of Origin</label>
                <input type="text" id="countryOfOrigin" name="countryOfOrigin" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
              </div>
              
              <div class="col-span-1">
                <label for="modeOfShipment" class="block text-sm font-medium text-gray-700 mb-1">Mode of Shipment</label>
                <select id="modeOfShipment" name="modeOfShipment" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                  <option value="Air">Air</option>
                  <option value="Sea">Sea</option>
                  <option value="Courier">Courier</option>
                </select>
              </div>
              
              <div class="col-span-1">
                <label for="etd" class="block text-sm font-medium text-gray-700 mb-1">ETD (Estimated Time of Departure)</label>
                <input type="text" id="etd" name="etd" class="datepicker w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
              </div>
              
              <div class="col-span-1">
                <label for="eta" class="block text-sm font-medium text-gray-700 mb-1">ETA (Estimated Time of Arrival)</label>
                <input type="text" id="eta" name="eta" class="datepicker w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
              </div>
              
              <div class="col-span-1">
                <label for="freightCost" class="block text-sm font-medium text-gray-700 mb-1">Freight/Logistics Cost (KES)</label>
                <input type="number" id="freightCost" name="freightCost" min="0" step="0.01" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
              </div>
              
              <div class="col-span-1">
                <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select id="status" name="status" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                  <option value="Ordered">Ordered</option>
                  <option value="In Production">In Production</option>
                  <option value="Ready">Ready</option>
                  <option value="Shipped">Shipped</option>
                  <option value="Cleared">Cleared</option>
                  <option value="Delivered">Delivered</option>
                </select>
              </div>
              
              <div class="col-span-2">
                <label for="documents" class="block text-sm font-medium text-gray-700 mb-1">Supporting Documents</label>
                <div class="flex items-center justify-center w-full">
                  <label for="documents" class="flex flex-col w-full h-24 border-2 border-dashed rounded-lg border-gray-300 cursor-pointer bg-gray-50 hover:bg-gray-100">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                      <i class="fas fa-cloud-upload-alt text-gray-500 text-2xl mb-2"></i>
                      <p class="text-xs text-gray-500">
                        <span class="font-semibold">Click to upload</span> or drag and drop
                      </p>
                      <p class="text-xs text-gray-500">Invoice, PL, AWB/BL, COO, etc. (25MB max per file)</p>
                    </div>
                    <input id="documents" name="documents" type="file" class="hidden" multiple>
                  </label>
                </div>
                <div id="fileList" class="mt-2 space-y-1"></div>
              </div>
              
              <div class="col-span-2">
                <label for="remarks" class="block text-sm font-medium text-gray-700 mb-1">Remarks/Follow-ups</label>
                <textarea id="remarks" name="remarks" rows="2" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></textarea>
              </div>
            </div>
            
            <div class="mt-6 flex items-center justify-end pt-3 border-t">
              <button type="button" id="cancelBtn" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 mr-3">
                Cancel
              </button>
              <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Save Purchase
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-50"></div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script id="app-script">
    $(document).ready(function() {
      // Initialize datepicker
      flatpickr(".datepicker", {
        dateFormat: "Y-m-d",
        allowInput: true
      });

      // Initialize select2 for filters
      $('.filter-select').select2({
        placeholder: 'Select an option',
        allowClear: true
      });

      // DataTable initialization
      let table = $('#purchases-table').DataTable({
        responsive: true,
        scrollX: true,
        searching: true,
        ordering: true,
        paging: true,
        info: true,
        language: {
          emptyTable: "No purchases available yet"
        },
        columnDefs: [
          { width: '100px', targets: 0 }, // PO Number
          { width: '150px', targets: 1 }, // Supplier
          { width: '200px', targets: 2 }, // Description
          { width: '60px', targets: 3 }, // Qty
          { width: '100px', targets: 4 }, // Unit Price
          { width: '100px', targets: 5 }, // Total Value
          { width: '80px', targets: 6 }, // Currency
          { width: '120px', targets: 7 }, // Total KES
          { width: '80px', targets: 8 }, // Incoterm
          { width: '100px', targets: 9 }, // Origin
          { width: '80px', targets: 10 }, // Shipping
          { width: '100px', targets: 11 }, // ETA
          { width: '100px', targets: 12 }, // ETD
          { width: '100px', targets: 13 }, // Freight
          { width: '100px', targets: 14 }, // Status
          { width: '150px', targets: 15 }, // Documents
          { width: '200px', targets: 16 }, // Remarks
          { width: '80px', targets: 17, orderable: false } // Actions
        ]
      });

      // Modal functionality
      const modal = $('#addPurchaseModal');
      const openModalBtn = $('#addPurchaseBtn');
      const closeModalBtn = $('#closeModal');
      const cancelBtn = $('#cancelBtn');

      openModalBtn.on('click', function() {
        modal.removeClass('opacity-0 pointer-events-none');
        $('body').addClass('modal-active');
      });

      function closeModal() {
        modal.addClass('opacity-0 pointer-events-none');
        $('body').removeClass('modal-active');
        $('#purchaseForm')[0].reset();
        $('#fileList').empty();
      }

      closeModalBtn.on('click', closeModal);
      cancelBtn.on('click', closeModal);

      // Close modal when clicking outside
      modal.on('click', function(e) {
        if ($(e.target).hasClass('modal-overlay')) {
          closeModal();
        }
      });

      // Auto-calculate total value
      function calculateTotal() {
        const quantity = parseFloat($('#quantity').val()) || 0;
        const unitPrice = parseFloat($('#unitPrice').val()) || 0;
        const exchangeRate = parseFloat($('#exchangeRate').val()) || 0;
        const currency = $('#currency').val();
        
        const totalValue = quantity * unitPrice;
        const totalValueKES = totalValue * exchangeRate;
        
        $('#totalValue').val(`${currency} ${totalValue.toFixed(2)}`);
        $('#totalValueKES').val(`KES ${totalValueKES.toFixed(2)}`);
      }

      $('#quantity, #unitPrice, #exchangeRate').on('input', calculateTotal);

      // Handle currency change
      $('#currency').on('change', function() {
        const currency = $(this).val();
        
        // Show loading indicator
        $('#rateLoader').removeClass('hidden');
        
        // Simulate fetching exchange rate
        setTimeout(function() {
          let rate = 1;
          if (currency === 'USD') {
            rate = 145.5;
          } else if (currency === 'EUR') {
            rate = 156.75;
          }
          
          $('#exchangeRate').val(rate);
          $('#rateLoader').addClass('hidden');
          calculateTotal();
        }, 1000);
      });

      // Display selected files
      $('#documents').on('change', function(e) {
        const fileList = $('#fileList');
        fileList.empty();
        
        const files = e.target.files;
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const fileSize = (file.size / 1024 / 1024).toFixed(2); // in MB
          
          const fileItem = $('<div class="text-sm text-gray-500 flex items-center"></div>');
          fileItem.append(`<i class="fas fa-file-alt text-indigo-500 mr-2"></i>`);
          fileItem.append(`<span>${file.name} (${fileSize} MB)</span>`);
          
          fileList.append(fileItem);
        }
      });

      // Load data from localStorage on page load
      function loadPurchases() {
        let purchases = JSON.parse(localStorage.getItem('purchases')) || [];
        
        // Clear table
        table.clear();
        
        // Add each purchase to table
        purchases.forEach(purchase => {
          addPurchaseToTable(purchase);
        });
        
        // Redraw table
        table.draw();
        
        // Update totals
        updateTotals();
        
        // Update filter options
        updateFilterOptions(purchases);
      }

      // Add purchase to DataTable
      function addPurchaseToTable(purchase) {
        const statusClass = `status-${purchase.status.toLowerCase().replace(/\s+/g, '-')}`;
        
        const documentsList = purchase.documents && purchase.documents.length 
          ? purchase.documents.map(doc => `<span class="text-xs block"><i class="fas fa-file-alt mr-1"></i>${doc}</span>`).join('') 
          : '<span class="text-xs text-gray-400">No documents</span>';
          
        table.row.add([
          purchase.poNumber,
          purchase.supplierName,
          purchase.itemDescription,
          purchase.quantity,
          `${purchase.currency} ${parseFloat(purchase.unitPrice).toFixed(2)}`,
          `${purchase.currency} ${parseFloat(purchase.quantity * purchase.unitPrice).toFixed(2)}`,
          purchase.currency,
          `KES ${parseFloat(purchase.totalValueKES).toFixed(2)}`,
          purchase.incoterm,
          purchase.countryOfOrigin,
          purchase.modeOfShipment,
          purchase.eta || '-',
          purchase.etd || '-',
          `KES ${parseFloat(purchase.freightCost || 0).toFixed(2)}`,
          `<span class="px-2 py-1 text-xs rounded-full ${statusClass}">${purchase.status}</span>`,
          documentsList,
          purchase.remarks || '-',
          `<button class="text-blue-500 hover:text-blue-700 mr-2" data-id="${purchase.id}" data-action="edit"><i class="fas fa-edit"></i></button>
           <button class="text-red-500 hover:text-red-700" data-id="${purchase.id}" data-action="delete"><i class="fas fa-trash-alt"></i></button>`
        ]).draw(false);
      }

      // Update totals
      function updateTotals() {
        const purchases = JSON.parse(localStorage.getItem('purchases')) || [];
        
        let totalQuantity = 0;
        let totalKES = 0;
        let totalUSD = 0;
        let totalEUR = 0;
        
        purchases.forEach(purchase => {
          totalQuantity += parseFloat(purchase.quantity);
          totalKES += parseFloat(purchase.totalValueKES);
          
          const itemTotal = parseFloat(purchase.quantity) * parseFloat(purchase.unitPrice);
          if (purchase.currency === 'USD') {
            totalUSD += itemTotal;
          } else if (purchase.currency === 'EUR') {
            totalEUR += itemTotal;
          }
        });
        
        $('#total-quantity').text(totalQuantity);
        $('#total-kes').text(`KES ${totalKES.toFixed(2)}`);
        
        let totalValueText = '';
        if (totalKES > 0) totalValueText += `KES ${totalKES.toFixed(2)} `;
        if (totalUSD > 0) totalValueText += `USD ${totalUSD.toFixed(2)} `;
        if (totalEUR > 0) totalValueText += `EUR ${totalEUR.toFixed(2)}`;
        
        $('#total-value').text(totalValueText || '-');
      }

      // Update filter options
      function updateFilterOptions(purchases) {
        const suppliers = [...new Set(purchases.map(p => p.supplierName))];
        
        // Clear and repopulate supplier filter
        const supplierFilter = $('#filter-supplier');
        const currentSupplier = supplierFilter.val();
        supplierFilter.empty().append('<option value="">All Suppliers</option>');
        
        suppliers.forEach(supplier => {
          supplierFilter.append(`<option value="${supplier}">${supplier}</option>`);
        });
        
        if (currentSupplier && suppliers.includes(currentSupplier)) {
          supplierFilter.val(currentSupplier);
        }
        
        // Refresh select2
        $('.filter-select').trigger('change');
      }

      // Apply filters to DataTable
      $('.filter-select').on('change', function() {
        const supplierFilter = $('#filter-supplier').val();
        const currencyFilter = $('#filter-currency').val();
        const shipmentFilter = $('#filter-shipment').val();
        const statusFilter = $('#filter-status').val();
        
        // Custom filtering function
        $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
          const supplier = data[1]; // Supplier Name column
          const currency = data[6]; // Currency column
          const shipment = data[10]; // Mode of Shipment column
          const status = data[14].replace(/<[^>]*>/g, ''); // Status column (removing HTML)
          
          // Check each filter
          if (supplierFilter && supplier !== supplierFilter) return false;
          if (currencyFilter && currency !== currencyFilter) return false;
          if (shipmentFilter && shipment !== shipmentFilter) return false;
          if (statusFilter && !status.includes(statusFilter)) return false;
          
          return true;
        });
        
        // Redraw table with filters applied
        table.draw();
        
        // Remove the custom filtering function
        $.fn.dataTable.ext.search.pop();
      });

      // Handle form submission
      $('#purchaseForm').on('submit', function(e) {
        e.preventDefault();
        
        // Get form data
        const formData = {
          id: new Date().getTime(), // Unique ID
          poNumber: $('#poNumber').val(),
          supplierName: $('#supplierName').val(),
          itemDescription: $('#itemDescription').val(),
          quantity: parseFloat($('#quantity').val()),
          unitPrice: parseFloat($('#unitPrice').val()),
          currency: $('#currency').val(),
          exchangeRate: parseFloat($('#exchangeRate').val()),
          totalValueKES: parseFloat($('#quantity').val()) * parseFloat($('#unitPrice').val()) * parseFloat($('#exchangeRate').val()),
          incoterm: $('#incoterm').val(),
          countryOfOrigin: $('#countryOfOrigin').val(),
          modeOfShipment: $('#modeOfShipment').val(),
          etd: $('#etd').val(),
          eta: $('#eta').val(),
          freightCost: parseFloat($('#freightCost').val() || 0),
          status: $('#status').val(),
          remarks: $('#remarks').val(),
          documents: Array.from($('#documents')[0].files || []).map(file => file.name)
        };
        
        // Save to localStorage
        const purchases = JSON.parse(localStorage.getItem('purchases')) || [];
        purchases.push(formData);
        localStorage.setItem('purchases', JSON.stringify(purchases));
        
        // Add to table
        addPurchaseToTable(formData);
        
        // Update totals
        updateTotals();
        
        // Update filter options
        updateFilterOptions(purchases);
        
        // Show success message
        Toastify({
          text: "Purchase added successfully!",
          duration: 3000,
          gravity: "bottom",
          position: "right",
          backgroundColor: "#10B981",
          stopOnFocus: true
        }).showToast();
        
        // Close modal and reset form
        closeModal();
      });

      // Handle edit and delete actions
      $('#purchases-tbody').on('click', 'button', function() {
        const action = $(this).data('action');
        const id = $(this).data('id');
        const purchases = JSON.parse(localStorage.getItem('purchases')) || [];
        const purchaseIndex = purchases.findIndex(p => p.id === id);
        
        if (purchaseIndex === -1) return;
        
        if (action === 'delete') {
          if (confirm('Are you sure you want to delete this purchase?')) {
            purchases.splice(purchaseIndex, 1);
            localStorage.setItem('purchases', JSON.stringify(purchases));
            
            table.row($(this).parents('tr')).remove().draw();
            updateTotals();
            updateFilterOptions(purchases);
            
            Toastify({
              text: "Purchase deleted successfully!",
              duration: 3000,
              gravity: "bottom",
              position: "right",
              backgroundColor: "#EF4444",
              stopOnFocus: true
            }).showToast();
          }
        } else if (action === 'edit') {
          // For now, just show a message that editing will be implemented later
          Toastify({
            text: "Editing functionality will be added in a future update",
            duration: 3000,
            gravity: "bottom",
            position: "right",
            backgroundColor: "#3B82F6",
            stopOnFocus: true
          }).showToast();
        }
      });
      
      // Load purchases on page load
      loadPurchases();
      
      // Set default exchange rates
      $('#currency').val('KES').trigger('change');
      $('#exchangeRate').val(1);
    });
  </script>
</body>
</html>
